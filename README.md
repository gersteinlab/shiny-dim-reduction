<!---
---
title: "Shiny Dimensionality Reduction"
pagetitle: Shiny Dimensionality Reduction
---
-->

# Shiny Dimensionality Reduction


##### Table of Contents  
[Overview](#overview)  
[Installing R](#installing-r)  
[Running App Code](#running-app-code)  
[Installing RStudio](#installing-rstudio)  
[Installing Rtools](#installing-rtools)  
[Installing Anaconda](#installing-anaconda)  
[Performing Reduction](#performing-reduction)  
[AWS Integration](#aws-integration)  
[Portable Executables](#portable-executables)  

<a name="overview"/>

## Overview

This workflow applies dimensionality reduction methods to tabular data and generates R Shiny apps for interactive, precomputed visualization of the results. Supported analyses include:

* Principal Component Analysis (PCA)
* Variational Autoencoders (VAE)
* Uniform Manifold Approximation and Projection (UMAP)
* Potential of Heat diffusion for Affinity-based Transition Embedding (PHATE)
* t-Distributed Stochastic Neighbor Embedding (tSNE)
* Set Thresholding and Intersection with UpSetR
* Hierarchical Density-based Spatial Clustering of Applications with Noise (HDBSCAN)  

There are three ways to use this workflow:

* <b>Portable App:</b> If you received a portable Windows application generated by this workflow, no installations are necessary. To run the application, unzip the directory and run "run.bat".  
* <b>App Code:</b> If you possess source code for an application generated by this workflow, read the "Installing R" and "Running App Code" sections of this document.  
* <b>Reduction Workflow</b>: If you intend to perform dimensionality reduction with this workflow, please read the rest of this document before proceeding.  

Developed by Justin Chang under the mentorship of Joel Rozowsky and Mark Gerstein at the Gerstein Lab.

<a name="installing-r"/>

## Installing R

<b>If you intend to use this tool's data analysis workflow, we recommend R >= 4.0.0.</b>  

You can download an installer for R from https://cran.r-project.org.  
For reproducibility, the following settings were used in development:  

* Run the installer as an administrator.  
* Keep the default installation location.  
* Select the 64-bit user installation.  
* Select customized startup, MDI, plain text help, no start menu folder.  
* Keep the defaults for additional tasks.  

<a name="running-app-code"/>

## Running App Code

Use R to navigate to the app directory and run the following command to set up the app:

```
source("install.R")
```

On subsequent uses, you can run the following two commands to immediately launch the app:

```
library(shiny)
runApp("app.R")
```

<a name="installing-rstudio"/>

## Installing RStudio

<b>If you intend to use this tool's dimensionality reduction & visualization workflow, we recommend RStudio >= 1.3.0.</b>

You can download an installer for RStudio from https://rstudio.com/products/rstudio/download.  
For reproducibility, the following settings were used in development:  

* Run the installer as an administrator. Keep the default installation location.  
* Do not create start menu shortcuts. Do not allow automated crash reporting.  

<a name="installing-rtools"/>

## Installing Rtools

<b>If you intend to use this tool's dimensionality reduction & visualization workflow, we recommend Rtools >= Rtools40.</b>

You can download an installer for Rtools40 from https://cran.r-project.org/bin/windows/Rtools.  
For reproducibility, the following settings were used in development:  

* Run the installer as an administrator. Keep the default installation location.  
* Save version history to registry and don't create start menu icons.  

<a name="installing-anaconda"/>

## Installing Anaconda

If you intend to use this tool's dimensionality reduction & visualization workflow, a specialized Anaconda environment is necessary:  

* If you do not have Anaconda, a Python package manager, please ensure RStudio is closed and install it from https://anaconda.com in a PATH without spaces, such as "C:/Anaconda".  
* If you have Anaconda, please ensure that no existing environments are named "r-reticulate". To do so, run "conda env remove --name r-reticulate". If the r-reticulate folder persists, delete it manually.  

Then set up r-reticulate in the Anaconda Command Prompt:  

```
conda create --name r-reticulate
conda activate r-reticulate
conda install keras matplotlib numba pandas scikit-learn
pip install umap-learn
pip install phate
```

<a name="performing-reduction"/>

## Performing Reduction

If you intend to use this tool's dimensionality reduction & visualization workflow, please perform the following steps:
Note that TILDE needs to be replaced with the appropriate character.  
Go to your Windows environment variables ("env" in search).  
Set HOME, R_LIBS_USER under System Variables.  
Use the following R code to add Rtools to the PATH and specify the root directory of your projects (replace '~/Justin-Tool' with your intended directory):  

* "writeLines('PATH="\${RTOOLS40_HOME}\\usr\\bin;\${PATH}"', con = "TILDE/.Renviron")"
* "cat('SHINY_DIM_REDUCTION_ROOT="TILDE/Justin-Tool"\n', append=TRUE, file="TILDE/.Renviron")"
Restart RStudio and run the following snippets of R code to test functionality:
* "Sys.which("make")"  
* "Sys.getenv("SHINY_DIM_REDUCTION_ROOT")"  

The actual '.Renviron' file can be modified in a text editor to alter these settings.  

In your specified directory (SHINY_DIM_REDUCTION_ROOT), create a folder called "shiny-dim-reduction" and place all source code in "shiny-dim-reduction".  
To finish installation, open and execute the code in "installer.R".  
The following warning(s) can be safely ignored:  
"Your CPU supports instructions that this TensorFlow binary was not compiled to use ..." 

<a name="aws-integration"/>

## AWS Integration

This tool offers two options for storing the precomputed data that the application uses. 

* The first option is local storage. This is sufficient for portable executables, but
will not be hostable online via Shiny and requires the source code version to be accompanied by a dataset. 
* The second option is AWS.S3 storage, which resolves the issues above. Although AWS offers a free plan, the onus is on the user to ensure that their AWS usage does not exceed their budget.

To pursue AWS integration, the user must first create an "s3_master.R" file as shown in "s3_master_template.R" with the credentials of an AWS IAM account that has full permissions in Amazon S3. This master account will upload data and its credentials should not be distributed with the generated app.

Generated apps should each be distributed with a set of AWS keys that link to an account with limited permissions. These permissions generally ought to include list / get / put, but the overall budget and permissions are in the hands of the developer. Please see example_aws_json.txt for an example policy.

<a name="portable-executables"/>

## Portable Executables

To begin, install R-Portable and GoogleChromePortable into the portable folder that you intend to store your app in. Add this line to R-Portable/App/R-Portable/etc/Rprofile.site: 

```
.First = function(){.libPaths(.Library)}
```
  
Run R-Portable as an admin. Check that the library location is portable with .libPaths(). Copy the application directory to the portable folder and follow the instructions in "Running App Code" to install all necessary packages. Then create a file called runShinyApp.R with the following contents:

```
message('library paths:\n', paste('... ', .libPaths(), sep='', collapse='\n'))
options(browser='C:/Program Files (x86)/Google/Chrome/Application/chrome.exe')
shiny::runApp('app', launch.browser=T)
```

Create a file called run.bat with the following contents:

```
SET ROPTS=--no-save --no-environ --no-init-file --no-restore --no-Rconsole
R-Portable\App\R-Portable\bin\Rscript.exe %ROPTS% runShinyApp.R 1> ShinyApp.log 2>&1
```

After these steps, the portable folder should have the following structure:

* runShinyApp.R
* run.bat
* app (folder)
* reference (folder)
* R-Portable (folder)
* GoogleChromePortable (folder)
